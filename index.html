<!DOCTYPE html>
<html lang="ta">
<head>
<meta charset="UTF-8">
<title>Pro Vote Poll - Upload Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<style>
  body { margin: 0; font-family: 'Poppins', sans-serif; background: #111; color: white; text-align: center; }
  .title { background: #e63946; padding: 12px; margin: 0; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }

  /* 3-DOT MENU */
  .menu-container { position: fixed; top: 10px; right: 15px; z-index: 1000; }
  .dots-btn { background: rgba(255,255,255,0.1); border: none; color: white; font-size: 28px; cursor: pointer; padding: 5px 15px; border-radius: 50%; }
  .dropdown { display: none; position: absolute; right: 0; background: #222; min-width: 160px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); overflow: hidden; z-index: 1001; }
  .dropdown a { color: white; padding: 12px; text-decoration: none; display: block; border-bottom: 1px solid #333; font-size: 14px; text-align: left; }
  .dropdown a:hover { background: #e63946; }

  /* GRID */
  .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 12px; margin-top: 10px; }
  .card { background: #222; border-radius: 15px; overflow: hidden; cursor: pointer; border: 1px solid #333; transition: 0.3s; }
  .card:active { transform: scale(0.95); }
  .card img { width: 100%; height: 140px; object-fit: cover; background: #333; }
  .name { margin: 6px 0; font-weight: 600; color: #ffd166; font-size: 14px; }
  .progress { height: 8px; background: #333; margin: 8px; border-radius: 10px; overflow: hidden; }
  .progress span { display: block; height: 100%; width: 0%; background: #2a9d8f; transition: .5s; }

  /* POPUPS */
  .pop-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
  .pop-box { background: #1c1c1c; padding: 20px; border-radius: 20px; width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto; border: 1px solid #444; }
  .close-x { position: absolute; top: 10px; right: 15px; font-size: 28px; cursor: pointer; color: #888; }
  
  input, select { width: 100%; padding: 10px; margin: 8px 0; background: #222; border: 1px solid #444; border-radius: 8px; color: white; box-sizing: border-box; }
  .btn-action { background: #2a9d8f; color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }
  .btn-reset { background: #e63946; margin-bottom: 20px; }
  .loading-text { font-size: 12px; color: gold; display: none; }

  /* FOOTER */
  footer { background: #0b0b0b; padding: 15px; border-top: 2px solid #e63946; margin-top: 20px; }
  .footer-row { background: #1c1c1c; margin: 10px 0; padding: 12px; border-radius: 12px; text-align: left; }
  .footer-name { display: flex; justify-content: space-between; font-weight: 600; }
  .footer-progress { background: #333; height: 8px; border-radius: 10px; overflow: hidden; margin: 5px 0; }
  .footer-progress span { display: block; height: 100%; background: #2a9d8f; }
</style>
</head>
<body>

<div class="menu-container">
  <button class="dots-btn" onclick="toggleMenu()">‚ãÆ</button>
  <div id="dropdownMenu" class="dropdown">
    <a href="javascript:void(0)" onclick="openPop('infoPop')">‚ÑπÔ∏è Info</a>
    <a href="javascript:void(0)" onclick="openPop('loginPop')">üîë Admin Login</a>
    <a href="javascript:void(0)" onclick="location.reload()">üîÑ Refresh</a>
  </div>
</div>

<h1 class="title">üó≥Ô∏è ADVANCED VOTE POLL</h1>
<h2 id="timer">‚è≥ Syncing...</h2>

<div class="grid" id="mainGrid">
  <script>
    for(let i=1; i<=8; i++) {
      document.write(`
        <div class="card" onclick="vote(${i})">
          <img src="" id="img${i}" alt="Empty">
          <h3 id="n${i}" class="name">Unknown</h3>
          <div class="progress"><span id="p${i}"></span></div>
        </div>
      `);
    }
  </script>
</div>

<div id="infoPop" class="pop-overlay">
  <div class="pop-box">
    <span class="close-x" onclick="closePop('infoPop')">&times;</span>
    <h3>‚ÑπÔ∏è Voting Information</h3>
    <ul style="text-align: left; font-size: 14px; line-height: 1.6;">
      <li>Oru device moolama oru murai mattumae vote seiya mudiyum.</li>
      <li>Admin timer mudindhavudan winner announcement automatic-ah varum.</li>
      <li>Live results keelae ulla ranking section-il paarkalam.</li>
      <li>Reset seiyappattal thirumba vote podalam.</li>
    </ul>
    <button class="btn-action" onclick="closePop('infoPop')">Got it!</button>
  </div>
</div>

<div id="loginPop" class="pop-overlay">
  <div class="pop-box">
    <span class="close-x" onclick="closePop('loginPop')">&times;</span>
    <h3>Admin Auth</h3>
    <input type="text" id="adminUser" placeholder="Username">
    <input type="password" id="adminPass" placeholder="Password">
    <button class="btn-action" onclick="checkAdmin()">Login</button>
  </div>
</div>

<div id="settingsPop" class="pop-overlay">
  <div class="pop-box">
    <span class="close-x" onclick="closePop('settingsPop')">&times;</span>
    <h3>Dashboard</h3>
    <button class="btn-action btn-reset" onclick="fullReset()">‚ö†Ô∏è FULL RESET SYSTEM</button>

    <div style="text-align: left; background:#2a2a2a; padding:10px; border-radius:10px;">
      <h4 style="margin:0 0 10px 0; color:#e63946;">1. Set Timer</h4>
      <input type="datetime-local" id="adminDateTime" step="1">
    </div>

    <div style="text-align: left; background:#2a2a2a; padding:10px; border-radius:10px; margin-top:10px;">
      <h4 style="margin:0 0 10px 0; color:#e63946;">2. Update Member</h4>
      <select id="editId">
        <script>for(let i=1;i<=8;i++) document.write(`<option value="${i}">Member ${i}</option>`);</script>
      </select>
      <input type="text" id="editName" placeholder="New Name">
      <label style="font-size:12px;">Upload Image:</label>
      <input type="file" id="editImgFile" accept="image/*">
      <p id="uploadStatus" class="loading-text">Uploading Image... Please Wait.</p>
    </div>

    <button class="btn-action" onclick="pushUpdates()">üíæ SAVE EVERYTHING</button>
  </div>
</div>

<footer><h3>üìä Live Rankings</h3><div id="footerResults"></div></footer>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBLyf_dz6xPC9wdthZSVtpatkc8JgFhE4Q",
  authDomain: "chatbox-chats.firebaseapp.com",
  databaseURL: "https://chatbox-chats-default-rtdb.firebaseio.com",
  projectId: "chatbox-chats",
  storageBucket: "chatbox-chats.appspot.com",
  messagingSenderId: "10200860576",
  appId: "1:10200860576:android:262315d86f6d1732ddc6c5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

let localNames = {};

/* üîπ DATA SYNC - Updates names and images */
db.ref("pollData").on("value", snap => {
  const data = snap.val() || {};
  for(let i=1; i<=8; i++) {
    const m = data["m"+i] || { name: "Empty", img: "" };
    document.getElementById("n"+i).innerText = m.name;
    document.getElementById("img"+i).src = m.img || "https://via.placeholder.com/150";
    localNames[i] = m.name;
  }
});

/* üîπ TIMER LOGIC */
setInterval(() => {
  db.ref("settings/endTime").once("value", snap => {
    const end = snap.val();
    if(!end || end == 0) { 
      document.getElementById("timer").innerText = "‚è≥ Waiting for Start"; 
      return; 
    }
    const diff = end - Date.now();
    if(diff <= 0) { 
      document.getElementById("timer").innerText = "‚è∞ Voting Closed"; 
    } else {
      const d = Math.floor(diff/(1000*60*60*24)), 
            h = Math.floor((diff%(1000*60*60*24))/(1000*60*60)), 
            m = Math.floor((diff%(1000*60))/(1000*60)), 
            s = Math.floor((diff%(1000*60))/1000);
      document.getElementById("timer").innerText = `‚è≥ ${d}d ${h}h ${m}m ${s}s`;
    }
  });
}, 1000);

/* üîπ ADMIN LOGIN */
function checkAdmin() {
  if(document.getElementById("adminUser").value==="admin" && document.getElementById("adminPass").value==="1234") {
    closePop('loginPop'); openPop('settingsPop');
  } else { alert("Access Denied"); }
}

/* üîπ PUSH UPDATES (Timer & Member Data) */
async function pushUpdates() {
  const id = document.getElementById("editId").value;
  const name = document.getElementById("editName").value;
  const file = document.getElementById("editImgFile").files[0];
  const dateTime = document.getElementById("adminDateTime").value;

  // 1. Update Timer
  if(dateTime) {
    db.ref("settings").update({ endTime: new Date(dateTime).getTime() });
  }

  // 2. Update Name
  if(name) {
    db.ref("pollData/m"+id).update({ name: name });
  }

  // 3. Update Image
  if(file) {
    document.getElementById("uploadStatus").style.display = "block";
    try {
      const ref = storage.ref(`images/member${id}_${Date.now()}`);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      db.ref("pollData/m"+id).update({ img: url });
    } catch(e) { alert("Upload Failed: " + e.message); }
    document.getElementById("uploadStatus").style.display = "none";
  }
  alert("Settings Saved!");
}

/* üîπ FULL RESET (The key fix for your issue) */
function fullReset() {
  if(!confirm("Are you sure? This clears all votes and lets everyone vote again.")) return;
  
  // Clear the vote counts
  db.ref("votes").remove();
  
  // Set a new resetToken (Session ID) and stop the timer
  db.ref("settings").update({ 
    endTime: 0, 
    resetToken: Date.now() 
  });
  
  alert("System Fully Reset! You can now start a new poll.");
}

/* üîπ VOTING LOGIC with Reset Token Check */
function vote(n) {
  db.ref("settings").once("value").then(snap => {
    const settings = snap.val() || {};
    const endTime = settings.endTime;
    const serverResetToken = settings.resetToken || 0;
    const localResetToken = localStorage.getItem("myResetToken") || 0;

    // 1. Check if Poll is running
    if(!endTime || Date.now() > endTime) { 
      alert("Voting is currently closed."); 
      return; 
    }

    // 2. Check if user already voted IN THIS SESSION
    if(localStorage.getItem("voted") === "yes" && localResetToken == serverResetToken) { 
      alert("You have already voted in this poll!"); 
      return; 
    }

    // 3. Record Vote
    db.ref("votes/option"+n).transaction(v => (v||0)+1);
    
    // 4. Save session info to browser
    localStorage.setItem("voted", "yes");
    localStorage.setItem("myResetToken", serverResetToken);
    
    alert("Vote Registered for " + localNames[n] + "!");
  });
}

/* üîπ LIVE RESULTS SYNC */
db.ref("votes").on("value", snap => {
  const data = snap.val() || {};
  let total = 0, arr = [];
  
  for(let i=1; i<=8; i++) { 
    let v = data["option"+i] || 0; 
    total += v; 
    arr.push({id:i, votes:v}); 
  }

  // Sort by highest votes
  arr.sort((a,b) => b.votes - a.votes);
  
  let html = "";
  arr.forEach((o, i) => {
    let p = total ? ((o.votes/total)*100).toFixed(1) : 0;
    // Update main grid progress bars
    if(document.getElementById("p"+o.id)) document.getElementById("p"+o.id).style.width = p + "%";
    // Build footer ranking list
    html += `
      <div class="footer-row">
        <div class="footer-name">
          <span>${i+1}. ${localNames[o.id] || "Unknown"}</span>
          <span>${p}% (${o.votes})</span>
        </div>
        <div class="footer-progress"><span style="width:${p}%"></span></div>
      </div>`;
  });
  document.getElementById("footerResults").innerHTML = html;
});

/* üîπ UI HELPERS */
function openPop(id) { document.getElementById(id).style.display = "flex"; }
function closePop(id) { document.getElementById(id).style.display = "none"; }
function toggleMenu() { 
  const m = document.getElementById("dropdownMenu"); 
  m.style.display = (m.style.display==="block") ? "none" : "block"; 
}

// Close menu if clicked outside
window.onclick = function(event) {
  if (!event.target.matches('.dots-btn')) {
    document.getElementById("dropdownMenu").style.display = "none";
  }
}
</script>
</body>
</html>
